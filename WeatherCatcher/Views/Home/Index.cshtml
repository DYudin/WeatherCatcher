@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using WeatherCatcher.Models

@model City
@{
    ViewBag.Title = "Погода в городах";
}

@section Scripts {
    <script>
        var model = {
            cities: ko.observableArray(),
            editor: {
                name: ko.observable("")
            }
        };

        //function sendAjaxRequest(httpMethod, callback, url) {
        //    $.ajax("/api/web" + (url ? "/" + url : ""), {
        //        type: httpMethod,
        //        success: callback
        //    });
            
            function sendAjaxRequest(httpMethod, callback, url, reqData) {
                $.ajax("/api/web" + (url ? "/" + url : ""), {
                    type: httpMethod,
                    success: callback,
                    data: reqData
                });
            }

        function getAllItems() {
            sendAjaxRequest("GET", function(data) {
                model.cities.removeAll();
                for (var i = 0; i < data.length; i++) {
                    model.cities.push(data[i]);
                }
            });
        }

        function handleEditorClick() {
            sendAjaxRequest("POST", function (newItem) {
                model.cities.push(newItem);
            }, null, {
                Name: model.editor.name
}
            );
        }

        function removeItem(item) {
            sendAjaxRequest("DELETE", function () {
                getAllItems();
            }, item.Name);
        }

        $(document).ready(function() {
            getAllItems();
            ko.applyBindings(model);
        });
    </script>
}

@section Body {
<div id="summary" class="section panel panel-primary">
    <div class="panel-heading">Все города</div>
    <div class="panel-body">
        <table class="table table-striped table-condensed">
            <thead>
            <tr><th>Имя</th><th>Температура</th><th>Влажность</th><th>Давление</th><th>Погодные явления</th><th>Сервис</th></tr>
            </thead>
            <tbody data-bind="foreach: model.cities">
            <tr>
                <td data-bind="text: Name"></td>
                <td data-bind="text: Weather.Temperature"></td>
                <td data-bind="text: Weather.Humidity"></td>
                <td data-bind="text: Weather.Pressure"></td>
                <td data-bind="text: Weather.WeatherСonditions"></td>
                <td data-bind="text: Weather.WeatherService"></td>
                <td>
                    <button class="btn btn-xs btn-primary"
                            data-bind="click: removeItem">
                        Удалить
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

    <div id="editor" class="section panel panel-primary">
@Html.Partial("Creator", new City("test1", new Weather(25,25,25,"tt"), "test2"))
    </div>

@*<div id="editor2" class="section panel panel-primary">
        @*<div class="panel-heading">
            
        </div>*@
        @*<div class="panel-body">
            <div class="form-group">
                <label>Название города</label>
                <input class="form-control" data-bind="value: model.editor.name" />
            </div>
            <button class="btn btn-primary"
                    data-bind="click: handleEditorClick">
                Добавить
            </button>
        </div>*@
    @*</div>*@
}